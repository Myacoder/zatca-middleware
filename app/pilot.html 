const http = require('http');
const crypto = require('crypto');
const fs = require('fs');
const path = require('path');

/* ====================================================
   1. VALIDATION
==================================================== */
function validateInvoice(data) {
  const errors = [];
  if (!data.invoiceNumber) errors.push('invoiceNumber is required');
  if (!data.vatNumber) errors.push('vatNumber is required');
  if (!data.issueDate) errors.push('issueDate is required');
  if (data.totalAmount === undefined) errors.push('totalAmount is required');
  if (typeof data.totalAmount !== 'number')
    errors.push('totalAmount must be a number');
  return errors;
}

/* ====================================================
   2. ZATCA XML (SIMPLIFIED â€“ PILOT)
==================================================== */
function jsonToZatcaXml(invoice, previousHash) {
  return `
<Invoice
 xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
 xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
 xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
  <cbc:ID>${invoice.invoiceNumber}</cbc:ID>
  <cbc:IssueDate>${invoice.issueDate}</cbc:IssueDate>
  <cac:AdditionalDocumentReference>
    <cbc:ID>PreviousInvoiceHash</cbc:ID>
    <cbc:UUID>${previousHash || 'FIRST_INVOICE'}</cbc:UUID>
  </cac:AdditionalDocumentReference>
  <cac:AccountingSupplierParty>
    <cac:Party>
      <cbc:CompanyID>${invoice.vatNumber}</cbc:CompanyID>
    </cac:Party>
  </cac:AccountingSupplierParty>
  <cac:LegalMonetaryTotal>
    <cbc:PayableAmount currencyID="SAR">${invoice.totalAmount}</cbc:PayableAmount>
  </cac:LegalMonetaryTotal>
</Invoice>
`.trim();
}

/* ====================================================
   3. HASH + SIGNATURE (MOCK)
==================================================== */
function base64Encode(text) {
  return Buffer.from(text).toString('base64');
}

function sha256Hash(text) {
  return crypto.createHash('sha256').update(text).digest('hex');
}

function simulateSignature(hash) {
  return crypto.createHash('sha256').update('SIGN-' + hash).digest('hex');
}

/* ====================================================
   4. ZATCA B2C QR (REAL TLV)
==================================================== */
function generateZatcaB2CQR({ sellerName, vatNumber, timestamp, total, vat }) {
  const tlv = [
    Buffer.from([1, sellerName.length]), Buffer.from(sellerName),
    Buffer.from([2, vatNumber.length]), Buffer.from(vatNumber),
    Buffer.from([3, timestamp.length]), Buffer.from(timestamp),
    Buffer.from([4, total.toString().length]), Buffer.from(total.toString()),
    Buffer.from([5, vat.toString().length]), Buffer.from(vat.toString())
  ];
  return Buffer.concat(tlv).toString('base64');
}

/* ====================================================
   5. MOCK ZATCA SANDBOX
==================================================== */
function submitToZatcaSandbox() {
  return {
    clearanceStatus: 'CLEARED',
    reportingStatus: 'REPORTED',
    uuid: crypto.randomUUID(),
    timestamp: new Date().toISOString()
  };
}

/* ====================================================
   6. HTTP SERVER
==================================================== */
const server = http.createServer((req, res) => {

  /* ===============================
     PILOT VIEW PAGE
  =============================== */
  if (req.method === 'GET' && req.url === '/pilot') {
    const html = fs.readFileSync(
      path.join(__dirname, 'pilot.html'),
      'utf8'
    );

    // ðŸ”´ Paste a REAL QR base64 you already generated
    const invoiceData = {
      invoiceNumber: 'INV-PILOT-001',
      vatNumber: '300123456700003',
      totalAmount: 115,
      vatAmount: 17.25,
      timestamp: new Date().toISOString(),
      qrImageBase64: 'AQtERU1PIFNFTExFUgIPMzAwMTIzNDU2NzAwMDAzAxgyMDI2LTAxLTE2VDEwOjEyOjQ2LjExOVoEAzExNQUFMTcuMjU='
    };

    const finalHtml = html.replace(
      'const data = window.INVOICE_DATA;',
      `const data = ${JSON.stringify(invoiceData)};`
    );

    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end(finalHtml);
    return;
  }

  /* ===============================
     LOYVERSE WEBHOOK
  =============================== */
  if (req.method === 'POST' && req.url.startsWith('/webhook')) {
    let body = '';
    req.on('data', chunk => body += chunk.toString());
    req.on('end', () => {
      console.log('Webhook received:', body);
      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ status: 'RECEIVED' }));
    });
    return;
  }

  /* ===============================
     MANUAL /invoice TEST
  =============================== */
  if (req.method === 'POST' && req.url === '/invoice') {
    let body = '';
    req.on('data', chunk => body += chunk.toString());
    req.on('end', () => {
      let data;
      try {
        data = JSON.parse(body);
      } catch {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        return res.end(JSON.stringify({ status: 'ERROR', errors: ['Invalid JSON'] }));
      }

      const errors = validateInvoice(data);
      if (errors.length) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        return res.end(JSON.stringify({ status: 'ERROR', errors }));
      }

      const xml = jsonToZatcaXml(data);
      const base64Xml = base64Encode(xml);
      const hash = sha256Hash(base64Xml);

      const total = data.totalAmount;
      const vat = Number((total * 0.15).toFixed(2));

      const qrBase64 = generateZatcaB2CQR({
        sellerName: data.sellerName || 'DEMO SELLER',
        vatNumber: data.vatNumber,
        timestamp: new Date().toISOString(),
        total,
        vat
      });

      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({
        status: 'SUBMITTED_TO_SANDBOX',
        invoiceHash: hash,
        qrBase64,
        response: submitToZatcaSandbox()
      }));
    });
    return;
  }

  res.writeHead(404);
  res.end();
});

/* ====================================================
   7. START
==================================================== */
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`ZATCA sandbox middleware running on port ${PORT}`);
});